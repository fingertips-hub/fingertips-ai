# ğŸ”“ ç³»ç»Ÿé”å®šåå¿«æ·é”®å¤±æ•ˆé—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

### ç—‡çŠ¶

å½“ç”¨æˆ·æŒ‰ `Win+L` é”å®š Windows å±å¹•åå†è§£é”ï¼Œæ‰€æœ‰ç»‘å®šçš„å¿«æ·é”®éƒ½ä¸èµ·ä½œç”¨ã€‚

### å½±å“èŒƒå›´

- é¼ æ ‡é•¿æŒ‰è§¦å‘ï¼ˆå¦‚ `Ctrl+LongPress:Middle`ï¼‰
- é”®ç›˜å¿«æ·é”®è§¦å‘ï¼ˆå¦‚ `Alt+Q`ï¼‰
- AI å¿«æ·æŒ‡ä»¤çš„å¿«æ·é”®

## æ ¹æœ¬åŸå› åˆ†æ

### æŠ€æœ¯ç»†èŠ‚

1. **uIOhook åœ¨ç³»ç»Ÿé”å®šåå¤±æ•ˆ**ï¼š
   - `uiohook-napi` ä½¿ç”¨ Windows ç³»ç»Ÿçº§é’©å­ï¼ˆç±»ä¼¼ `SetWindowsHookEx`ï¼‰
   - å½“ç”¨æˆ·æŒ‰ `Win+L` é”å®šä¼šè¯æ—¶ï¼ŒWindows ä¼šæŒ‚èµ·ç”¨æˆ·ä¼šè¯
   - ç³»ç»Ÿçº§é’©å­åœ¨ä¼šè¯æŒ‚èµ·æ—¶ä¼šè¢«ç³»ç»Ÿç§»é™¤æˆ–å¤±æ•ˆ
   - **è§£é”åé’©å­ä¸ä¼šè‡ªåŠ¨æ¢å¤**

2. **çŠ¶æ€è¿½è¸ªä¸å‡†ç¡®**ï¼š
   - `isListening` å˜é‡ä»ç„¶ä¿æŒä¸º `true`
   - `setupGlobalMouseListener()` æ£€æŸ¥åˆ°å·²åœ¨ç›‘å¬çŠ¶æ€ï¼Œç›´æ¥è¿”å›
   - å¯¼è‡´å³ä½¿é’©å­å¤±æ•ˆï¼Œä¹Ÿæ— æ³•é‡æ–°å¯åŠ¨ç›‘å¬å™¨

3. **ä¿®é¥°é”®çŠ¶æ€æ®‹ç•™**ï¼š
   - å¦‚æœé”å®šæ—¶æœ‰ä¿®é¥°é”®æŒ‰ä¸‹ï¼Œ`activeModifiers` é›†åˆä¸ä¼šæ¸…é™¤
   - å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

4. **ç¼ºå°‘ç³»ç»Ÿäº‹ä»¶ç›‘å¬**ï¼š
   - åŸä»£ç ä¸­æ²¡æœ‰ç›‘å¬ç³»ç»Ÿçš„é”å®š/è§£é”äº‹ä»¶
   - æ— æ³•åœ¨é€‚å½“æ—¶æœºåšç›¸åº”å¤„ç†

## è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ ç³»ç»Ÿäº‹ä»¶ç›‘å¬ (`src/main/index.ts`)

ä½¿ç”¨ Electron çš„ `powerMonitor` API ç›‘å¬ä»¥ä¸‹ç³»ç»Ÿäº‹ä»¶ï¼š

- **`lock-screen`**ï¼šç³»ç»Ÿé”å®šæ—¶è§¦å‘
  - æ¸…é™¤ä¿®é¥°é”®çŠ¶æ€ï¼Œé¿å…æŒ‰é”®çŠ¶æ€æ®‹ç•™
- **`unlock-screen`**ï¼šç³»ç»Ÿè§£é”æ—¶è§¦å‘
  - å»¶è¿Ÿ 500ms åé‡å¯ uIOhook ç›‘å¬å™¨
  - ç»™ç³»ç»Ÿè¶³å¤Ÿæ—¶é—´å®Œå…¨æ¢å¤

- **`resume`**ï¼šç³»ç»Ÿä»ç¡çœ /ä¼‘çœ æ¢å¤æ—¶è§¦å‘
  - å»¶è¿Ÿ 1000ms åé‡å¯ uIOhook ç›‘å¬å™¨
  - ç¡®ä¿ç³»ç»Ÿå®Œå…¨å”¤é†’åå†å¯åŠ¨é’©å­

### 2. æ·»åŠ é‡å¯æœºåˆ¶ (`src/main/modules/mouseListener.ts`)

æ–°å¢ä»¥ä¸‹åŠŸèƒ½å‡½æ•°ï¼š

#### `restartGlobalMouseListener()`

- å®‰å…¨åœ°åœæ­¢ç°æœ‰ç›‘å¬å™¨
- é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼ˆ`isListening`ã€`activeModifiers`ã€é•¿æŒ‰çŠ¶æ€ç­‰ï¼‰
- å»¶è¿Ÿ 100ms åé‡æ–°å¯åŠ¨
- å¦‚æœå¤±è´¥ï¼Œ1 ç§’åå†æ¬¡å°è¯•ï¼ˆé‡è¯•æœºåˆ¶ï¼‰

#### `clearModifierStates()`

- æ¸…é™¤ä¿®é¥°é”®çŠ¶æ€
- å–æ¶ˆé•¿æŒ‰æ£€æµ‹
- ç”¨äºç³»ç»Ÿé”å®šæ—¶æ¸…ç†çŠ¶æ€

### 3. å¥åº·æ£€æŸ¥æœºåˆ¶

å®ç°è‡ªåŠ¨å¥åº·ç›‘æµ‹ï¼š

#### äº‹ä»¶è¿½è¸ª

- åœ¨æ‰€æœ‰é¼ æ ‡å’Œé”®ç›˜äº‹ä»¶å¤„ç†å™¨ä¸­æ›´æ–° `lastEventTime`
- è¿½è¸ªæœ€åä¸€æ¬¡æ”¶åˆ°ç³»ç»Ÿäº‹ä»¶çš„æ—¶é—´

#### å®šæœŸæ£€æŸ¥

- æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡ uIOhook çŠ¶æ€
- å¦‚æœè¶…è¿‡ 5 åˆ†é’Ÿæ²¡æœ‰æ”¶åˆ°ä»»ä½•äº‹ä»¶ï¼Œè®¤ä¸ºé’©å­å¯èƒ½å¤±æ•ˆ
- è‡ªåŠ¨è§¦å‘é‡å¯æœºåˆ¶

#### ç”Ÿå‘½å‘¨æœŸç®¡ç†

- åœ¨ `setupGlobalMouseListener()` ä¸­å¯åŠ¨å¥åº·æ£€æŸ¥
- åœ¨ `stopGlobalMouseListener()` ä¸­åœæ­¢å¥åº·æ£€æŸ¥

### 4. æ”¹è¿›åœæ­¢æœºåˆ¶

åœ¨ `stopGlobalMouseListener()` ä¸­ï¼š

- åœæ­¢å¥åº·æ£€æŸ¥
- æ¸…é™¤æ‰€æœ‰çŠ¶æ€ï¼ˆä¿®é¥°é”®ã€é•¿æŒ‰ç­‰ï¼‰
- ç¡®ä¿å®Œå…¨æ¸…ç†

## å®ç°ç»†èŠ‚

### å…³é”®ä»£ç ä¿®æ”¹

#### ä¸»è¿›ç¨‹ (index.ts)

```typescript
import { powerMonitor } from 'electron'

// åœ¨ app.whenReady() ä¸­æ·»åŠ 
powerMonitor.on('lock-screen', () => {
  clearModifierStates()
})

powerMonitor.on('unlock-screen', () => {
  setTimeout(() => {
    restartGlobalMouseListener()
  }, 500)
})

powerMonitor.on('resume', () => {
  setTimeout(() => {
    restartGlobalMouseListener()
  }, 1000)
})
```

#### ç›‘å¬å™¨æ¨¡å— (mouseListener.ts)

```typescript
// å¥åº·æ£€æŸ¥çŠ¶æ€
let lastEventTime = Date.now()
let healthCheckInterval: NodeJS.Timeout | null = null

// åœ¨æ‰€æœ‰äº‹ä»¶å¤„ç†å™¨ä¸­æ›´æ–°æ—¶é—´
uIOhook.on('keydown', (event) => {
  lastEventTime = Date.now()
  // ... å…¶ä»–å¤„ç†
})

// å¥åº·æ£€æŸ¥å‡½æ•°
function startHealthCheck(): void {
  healthCheckInterval = setInterval(() => {
    const timeSinceLastEvent = Date.now() - lastEventTime
    if (timeSinceLastEvent > 5 * 60 * 1000) {
      restartGlobalMouseListener()
    }
  }, 30000)
}
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **åŸºæœ¬åŠŸèƒ½æµ‹è¯•**ï¼š
   - å¯åŠ¨åº”ç”¨
   - æµ‹è¯•å¿«æ·é”®æ˜¯å¦æ­£å¸¸å·¥ä½œ
   - æµ‹è¯•é¼ æ ‡é•¿æŒ‰è§¦å‘æ˜¯å¦æ­£å¸¸

2. **é”å±è§£é”æµ‹è¯•**ï¼š
   - æŒ‰ `Win+L` é”å®šå±å¹•
   - è¾“å…¥å¯†ç è§£é”
   - ç­‰å¾… 1-2 ç§’
   - æµ‹è¯•å¿«æ·é”®æ˜¯å¦æ¢å¤æ­£å¸¸å·¥ä½œ

3. **ç¡çœ å”¤é†’æµ‹è¯•**ï¼š
   - è®©ç”µè„‘è¿›å…¥ç¡çœ æ¨¡å¼
   - å”¤é†’ç”µè„‘
   - ç­‰å¾… 2-3 ç§’
   - æµ‹è¯•å¿«æ·é”®æ˜¯å¦æ¢å¤æ­£å¸¸å·¥ä½œ

4. **é•¿æ—¶é—´ç©ºé—²æµ‹è¯•**ï¼š
   - ä¿æŒåº”ç”¨è¿è¡Œ
   - 6 åˆ†é’Ÿå†…ä¸è§¦ç¢°é¼ æ ‡å’Œé”®ç›˜
   - å¥åº·æ£€æŸ¥åº”è¯¥ä¸ä¼šè§¦å‘é‡å¯ï¼ˆå› ä¸ºé˜ˆå€¼æ˜¯ 5 åˆ†é’Ÿï¼‰
   - ç„¶åæµ‹è¯•å¿«æ·é”®æ˜¯å¦ä»ç„¶æ­£å¸¸

### é¢„æœŸç»“æœ

- âœ… æ‰€æœ‰å¿«æ·é”®åœ¨é”å±è§£é”ååº”è¯¥è‡ªåŠ¨æ¢å¤
- âœ… æ§åˆ¶å°åº”è¯¥æ˜¾ç¤º "System unlocked, restarting mouse listener..."
- âœ… æ§åˆ¶å°åº”è¯¥æ˜¾ç¤º "âœ“ Mouse listener restarted successfully"
- âœ… ä¸åº”è¯¥æœ‰ä»»ä½•é”™è¯¯ä¿¡æ¯

## æ—¥å¿—å‚è€ƒ

### æ­£å¸¸é”å±è§£é”æµç¨‹

```
===============================================
ğŸ”’ System locked, cleaning up mouse listener state...
===============================================
[Lock] âœ“ Modifier states cleared
[MouseListener] Modifier states cleared

===============================================
ğŸ”“ System unlocked, restarting mouse listener...
===============================================
[MouseListener] Restarting global mouse listener...
[MouseListener] Stopped existing listener
[MouseListener] âœ“ Global mouse listener restarted successfully
[Unlock] âœ“ Mouse listener restarted successfully
[HealthCheck] Health check started
Global mouse listener started
```

### ç³»ç»Ÿæ¢å¤æµç¨‹

```
===============================================
âš¡ System resumed from suspend, restarting mouse listener...
===============================================
[MouseListener] Restarting global mouse listener...
[MouseListener] Stopped existing listener
[MouseListener] âœ“ Global mouse listener restarted successfully
[Resume] âœ“ Mouse listener restarted successfully
```

### å¥åº·æ£€æŸ¥è§¦å‘ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰

```
===============================================
âš ï¸ Health Check: No events received for 301s
uIOhook may have stopped working, attempting restart...
===============================================
[MouseListener] Restarting global mouse listener...
[HealthCheck] âœ“ Mouse listener restarted
```

## ç›¸å…³é—®é¢˜

è¿™ä¸ªä¿®å¤åŒæ—¶è§£å†³äº†ä»¥ä¸‹ç›¸å…³é—®é¢˜ï¼š

1. **ç¡çœ å”¤é†’åå¿«æ·é”®å¤±æ•ˆ**ï¼šé€šè¿‡ `resume` äº‹ä»¶ç›‘å¬è§£å†³
2. **ä¿®é¥°é”®çŠ¶æ€æ®‹ç•™**ï¼šé€šè¿‡é”å®šæ—¶æ¸…é™¤çŠ¶æ€è§£å†³
3. **é•¿æ—¶é—´ç©ºé—²åé’©å­å¤±æ•ˆ**ï¼šé€šè¿‡å¥åº·æ£€æŸ¥æœºåˆ¶è§£å†³

## æŠ€æœ¯è¯´æ˜

### ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿé‡å¯ï¼Ÿ

- **è§£é”å»¶è¿Ÿ (500ms)**ï¼šç³»ç»Ÿè§£é”åéœ€è¦æ—¶é—´æ¢å¤ç”¨æˆ·ä¼šè¯ï¼Œç«‹å³å¯åŠ¨é’©å­å¯èƒ½å¤±è´¥
- **å”¤é†’å»¶è¿Ÿ (1000ms)**ï¼šä»ç¡çœ /ä¼‘çœ æ¢å¤éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè®¾å¤‡é©±åŠ¨å¯èƒ½è¿˜åœ¨åˆå§‹åŒ–

### ä¸ºä»€ä¹ˆå¥åº·æ£€æŸ¥é˜ˆå€¼è®¾ä¸º 5 åˆ†é’Ÿï¼Ÿ

- é¿å…è¯¯åˆ¤ï¼šç”¨æˆ·å¯èƒ½çœŸçš„é•¿æ—¶é—´ä¸ä½¿ç”¨é¼ æ ‡å’Œé”®ç›˜
- ä¿å®ˆç­–ç•¥ï¼šåªåœ¨æ˜æ˜¾å¼‚å¸¸æ—¶æ‰é‡å¯
- ç³»ç»Ÿäº‹ä»¶ç›‘å¬æ˜¯ä¸»è¦æœºåˆ¶ï¼Œå¥åº·æ£€æŸ¥æ˜¯é¢å¤–ä¿é™©

### ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•æœºåˆ¶ï¼Ÿ

- ç³»ç»Ÿæ¢å¤æ—¶æœºä¸ç¡®å®šï¼šæŸäº›æƒ…å†µä¸‹å³ä½¿å»¶è¿Ÿåä»å¯èƒ½å¤±è´¥
- æé«˜å¯é æ€§ï¼šç¬¬äºŒæ¬¡å°è¯•æˆåŠŸç‡æ›´é«˜
- ç”¨æˆ·ä½“éªŒï¼šé¿å…å› ä¸€æ¬¡å¤±è´¥å°±æ°¸ä¹…å¤±æ•ˆ

## æœ€ä½³å®è·µ

### 1. åˆ†å±‚é˜²æŠ¤

- **ä¸»åŠ¨ç›‘å¬**ï¼šç³»ç»Ÿäº‹ä»¶ç›‘å¬ï¼ˆlock/unlock/resumeï¼‰
- **è¢«åŠ¨æ£€æµ‹**ï¼šå¥åº·æ£€æŸ¥æœºåˆ¶
- **å®¹é”™å¤„ç†**ï¼šé‡è¯•æœºåˆ¶

### 2. çŠ¶æ€ç®¡ç†

- æ‰€æœ‰çŠ¶æ€å˜é‡é›†ä¸­ç®¡ç†
- åœæ­¢æ—¶å®Œå…¨æ¸…ç†çŠ¶æ€
- é‡å¯æ—¶é‡ç½®æ‰€æœ‰çŠ¶æ€

### 3. æ—¥å¿—è®°å½•

- å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—è¾“å‡º
- æˆåŠŸ/å¤±è´¥éƒ½æœ‰æ˜ç¡®æ ‡è®°ï¼ˆâœ“/âœ—ï¼‰
- ä¾¿äºé—®é¢˜æ’æŸ¥å’ŒéªŒè¯

### 4. ç”¨æˆ·ä½“éªŒ

- è‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- å»¶è¿Ÿè®¾ç½®åˆç†ï¼Œé¿å…é—ªçƒ
- é™é»˜å¤„ç†ï¼Œä¸æ‰“æ‰°ç”¨æˆ·

## ç‰ˆæœ¬å†å²

- **v1.0.0** - 2024-10-24
  - åˆå§‹å®ç°
  - æ·»åŠ ç³»ç»Ÿäº‹ä»¶ç›‘å¬
  - æ·»åŠ é‡å¯æœºåˆ¶
  - æ·»åŠ å¥åº·æ£€æŸ¥

## å‚è€ƒèµ„æ–™

- [Electron powerMonitor API](https://www.electronjs.org/docs/latest/api/power-monitor)
- [uiohook-napi Documentation](https://github.com/SnosMe/uiohook-napi)
- [Windows Session Lock Events](https://docs.microsoft.com/en-us/windows/win32/shutdown/system-shutdown)
